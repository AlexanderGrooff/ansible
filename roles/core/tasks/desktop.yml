---
- name: Add alacritty repo GPG key
  apt_key:
    keyserver: keyserver.ubuntu.com
    id: 5B7FC40A404FAD98548806028AC9B4BBBAB4900B
  become: yes
  when: ansible_os_family == "Debian"

- name: Add alacritty apt repo
  apt_repository:
    repo: ppa:mmstick76/alacritty
  become: yes
  when: ansible_os_family == "Debian"

- name: Define desktop packages
  set_fact:
    desktop_packages: [
      alacritty,
      flameshot,
      pavucontrol,
      pkg-config,
    ]

- name: Define Debian specific desktop packages
  set_fact:
    debian_desktop_packages: [
      fonts-font-awesome,
      libfontconfig1-dev,
      libfreetype6-dev,
      libxcb-xfixes0-dev,
      libxkbcommon-dev,
      network-manager-gnome,  # Contains nm-applet
    ]

- name: Define arch specific desktop packages
  set_fact:
    arch_desktop_packages: [
      aconfmgr-git,
      gnome-keyring,  # https://github.com/MicrosoftDocs/live-share/issues/224#issuecomment-383324321
      nm-applet,  # Networkmanager GUI
      slack-desktop,
      ttf-font-awesome,
      visual-studio-code-bin,
      xaskpass,  # Places /usr/bin/xaskpass
    ]

- name: Define i3 packages
  set_fact:
    i3_packages: [
      autorandr,
      dunst,
      i3-wm,
      i3lock,
      py3status,
      rofi,
    ]

- name: Define kdm packages
  set_fact:
    kde_packages: [
      kde-plasma-desktop,
      kwin-bismuth,  # WM
    ]

- name: Define redundant packages for Debian
  set_fact:
    debian_redundant_desktop_packages: [
      gnome-desktop3-data,
      gnome-shell,  # Not sure if this is the actual gnome package
    ]

- name: Define redundant packages for Arch
  set_fact:
    arch_redundant_desktop_packages: [
      xterm,  # Default i3 terminal
    ]

- name: Install generic desktop packages for Debian
  apt:
    name: "{{ desktop_packages }}"
  become: true
  when: ansible_os_family == "Debian"

- name: Install specific desktop packages for Debian
  apt:
    name: "{{ debian_desktop_packages }}"
  become: true
  when: ansible_os_family == "Debian"

- name: Install specific desktop packages for Arch
  kewlfft.aur.aur:
    name: "{{ arch_desktop_packages }}"
  when: ansible_distribution == "Archlinux"

- name: Remove redundant desktop packages for Debian
  apt:
    name: "{{ debian_redundant_desktop_packages }}"
    state: absent
  become: true
  when: ansible_os_family == "Debian"

- name: Remove redundant desktop packages for Arch
  pacman:
    name: "{{ arch_redundant_desktop_packages }}"
    state: absent
  become: yes
  when: ansible_distribution == "Archlinux"

- name: Manage i3wm
  block:
    - name: Install i3 desktop packages for Arch
      kewlfft.aur.aur:
        name: "{{ i3_packages }}"
      when: ansible_distribution == "Archlinux"

    - name: Install desktop packages for Debian
      apt:
        name: "{{ i3_packages }}"
        state: latest
      become: true
      when: ansible_os_family == "Debian"

    - name: Install i3 pip packages
      pip:
        name: [
          i3-cycle
        ]
        state: latest

    - name: Remove kde packages
      apt:
        name: "{{ kde_packages }}"
        state: absent
      become: yes
      when: ansible_os_family == "Debian"
  when: desktop.wm == "i3"

- name: Manage Sway
  block:
    - name: Install sway
      apt:
        name: [
          grimshot,  # Screenshot tool
          sway,
          swaylock,
          wdisplays,
          weston,  # Compositor
        ]
        state: latest
      become: true
      when: ansible_os_family == "Debian"
  when: desktop.wm == "sway"

- name: Manage KDE
  block:
  # Docs at https://volian.org/bismuth/
  - name: Add Bismuth GPG apt Key
    apt_key:
      url: https://deb.volian.org/volian/scar.key
      state: present
    when: ansible_os_family == "Debian"
    become: yes

  - name: Add Bismuth Repository
    apt_repository:
      repo: "deb http://deb.volian.org/volian/ scar main"
      state: present
    when: ansible_os_family == "Debian"
    become: yes

  - name: Install kde packages
    apt:
      name: "{{ kde_packages }}"
      state: latest
    when: ansible_os_family == "Debian"
    become: yes

  - name: Remove i3 packages
    apt:
      name: "{{ i3_packages }}"
      state: absent
    become: yes
    when: ansible_os_family == "Debian"
  when: desktop.wm == "kde"

- name: Symlink xaskpass to ssh lib
  file:
    src: /usr/bin/xaskpass
    dest: /usr/lib/ssh/ssh-askpass
    state: link
  become: yes
  when: ansible_distribution == "Archlinux"

- name: Create user service directory
  file:
    path: /home/alex/.config/systemd/user/
    state: directory
    recurse: yes
    owner: alex
    group: alex

- name: Place user service files
  template:
    src: config/systemd/user/hnproxy.service
    dest: /home/alex/.config/systemd/user/hnproxy.service
    owner: alex
    group: alex

- name: Start hnproxy service
  systemd:
    name: hnproxy
    state: started
    enabled: yes
    scope: user
    daemon_reload: yes
