---
# TODO: Clone awx and change configs

- name: Check if certificate exists
  stat: path=/etc/letsencrypt/live/awx.agrooff.com/fullchain.pem
  become: yes
  become_user: root
  register: cert_path

- name: Set awx nginx http config
  template:
    src: nginx/awx_http.conf
    dest: /etc/nginx/sites-enabled/awx.conf
    owner: root
    group: root
    mode: 0644
  become: yes
  become_user: root
  notify: reload-nginx
  when: not cert_path.stat.exists

- name: Generate letsencrypt certificates
  command: certbot certonly -d awx.agrooff.com --nginx -m alexandergrooff@gmail.com --agree-tos -n
  become: yes
  become_user: root
  when: not cert_path.stat.exists
  register: cert_generation

- name: Set awx nginx https config
  template:
    src: nginx/awx_force_https.conf
    dest: /etc/nginx/sites-enabled/awx.conf
    owner: root
    group: root
    mode: 0644
  become: yes
  become_user: root
  notify: reload-nginx
  when: cert_path.stat.exists or cert_generation.changed
