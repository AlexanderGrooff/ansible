---
- include: apply_helm.yml
  with_items:
  - name: prometheus
    repo_url: https://prometheus-community.github.io/helm-charts
    namespace: monitoring
  - name: metallb
    repo_url: https://metallb.github.io/metallb
  - name: ingress-nginx
    repo_url: https://kubernetes.github.io/ingress-nginx
  - name: cert-manager
    repo_url: https://charts.jetstack.io
  - name: coredns
    repo_url: https://coredns.github.io/helm
    namespace: coredns
  - name: grafana
    repo_url: https://grafana.github.io/helm-charts
    namespace: monitoring
  - name: loki
    repo_url: https://grafana.github.io/helm-charts
    namespace: monitoring
  - name: promtail
    repo_url: https://grafana.github.io/helm-charts
    namespace: monitoring
  - name: airflow
    repo_url: https://airflow.apache.org/

- include: apply_config.yml
  with_items:
  - metallb-config.yaml.j2
  - cloudflare-secret.yaml.j2
  - issuer.yaml.j2

# Bit of a hack: we copy the files to the PVC that was just created
# Ideally we'd use git-sync, but that's too much work for now
- name: Copy over DAGs to Airflow volume
  kubernetes.core.k8s_cp:
    namespace: airflow
    pod: airflow-worker-0
    remote_path: "/opt/airflow/dags/{{ item | basename }}"
    local_path: "{{ item }}"
    container: worker
  with_fileglob:
  - files/airflow/dags/*

- include: freqtrade.yml
